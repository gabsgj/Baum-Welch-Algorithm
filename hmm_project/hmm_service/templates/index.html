<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HMM Training Dashboard Redesign v1</title>
    <meta name="description"
        content="Real-time Hidden Markov Model training dashboard using the Baum-Welch Expectation-Maximization algorithm">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap"
        rel="stylesheet">

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        sapphire: {
                            50: '#eff4ff', 100: '#dbe6fe', 200: '#bfd3fe',
                            300: '#93b4fd', 400: '#6090fa', 500: '#1d4ed8', // Darker primary
                            600: '#1e40af', 700: '#1e3a8a', 800: '#1e3a8a', 900: '#1a2f6b',
                        },
                        academic: { bg: '#F3F4F6', card: '#FFFFFF', border: '#E5E7EB', muted: '#6B7280' } // Lighter bg
                    }
                }
            }
        }
    </script>

    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <!-- HMM Diagram -->
    <link rel="stylesheet" href="/static/css/hmm_diagram.css">

    <style>
        body {
            background-color: #FAF9F6;
            font-family: 'Inter', system-ui, sans-serif;
        }

        .font-mono-num {
            font-family: 'JetBrains Mono', monospace;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            80%,
            100% {
                transform: scale(2.2);
                opacity: 0;
            }
        }

        .status-pulse .pulse-dot {
            animation: pulse-ring 1.4s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .card {
            background: #FFFFFF;
            border: 1px solid #E2E0DC;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.03);
        }

        .heatmap-cell {
            transition: background-color 0.3s ease;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
        }

        /* ── (HMM Diagram styles in /static/css/hmm_diagram.css) ── */

        .pi-bar {
            transition: width 0.3s ease;
            background: linear-gradient(90deg, #2563EB, #6090fa);
            border-radius: 3px;
            height: 28px;
        }

        .section-title {
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #94918B;
        }

        .js-plotly-plot .plotly .modebar {
            display: none !important;
        }

        .d3-tooltip {
            position: absolute;
            background: rgba(30, 58, 138, 0.92);
            color: #fff;
            padding: 6px 10px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            pointer-events: none;
            z-index: 50;
            white-space: nowrap;
        }

        /* ── Iteration Log Table ── */
        .iter-table {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.72rem;
        }

        .iter-table th {
            background: #f8f7f4;
            position: sticky;
            top: 0;
            z-index: 5;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 0.68rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
        }

        .iter-table td,
        .iter-table th {
            padding: 6px 10px;
            border-bottom: 1px solid #f1f0ed;
            white-space: nowrap;
        }

        .iter-table tbody tr:hover {
            background: #f8f7f4;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #d1d0cc;
            border-radius: 3px;
        }
    </style>
</head>

<body class="min-h-screen antialiased text-slate-800 bg-academic-bg">

    <!-- ══════════════ 1. HEADER (Simplified) ══════════════ -->
    <header class="py-6 text-center">
        <!-- Status Badge Hidden/Moved -->
        <div id="status-badge" class="hidden"> <span id="status-text"></span> </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 pb-20 space-y-8">

        <!-- ══════════════ 2. CONFIGURATION CARD ══════════════ -->
        <section>
            <div class="card p-8 bg-white shadow-sm rounded-lg border border-slate-200">
                <h2 class="text-xl font-bold text-slate-900 mb-6 text-center">HMM Training Dashboard Redesign v1</h2>
                
                <form id="train-form" class="space-y-6">
                    <!-- Top Row: Controls -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label for="n-states" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Hidden States (N)</label>
                            <input id="n-states" type="number" min="2" max="10" value="2"
                                class="w-full px-4 py-2 border border-slate-300 rounded text-base font-mono focus:outline-none focus:ring-2 focus:ring-sapphire-500 focus:border-sapphire-500 transition shadow-sm">
                        </div>
                        <div>
                            <label for="max-iter" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Max Iterations</label>
                            <input id="max-iter" type="number" min="1" max="2000" value="100"
                                class="w-full px-4 py-2 border border-slate-300 rounded text-base font-mono focus:outline-none focus:ring-2 focus:ring-sapphire-500 focus:border-sapphire-500 transition shadow-sm">
                        </div>
                        <div>
                            <label for="tolerance" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Tolerance</label>
                            <input id="tolerance" type="text" value="1e-6"
                                class="w-full px-4 py-2 border border-slate-300 rounded text-base font-mono focus:outline-none focus:ring-2 focus:ring-sapphire-500 focus:border-sapphire-500 transition shadow-sm">
                        </div>
                    </div>

                    <!-- Train Button -->
                    <div>
                        <button type="submit" id="train-btn"
                            class="w-full flex items-center justify-center py-3 px-6 bg-sapphire-700 text-white font-semibold rounded hover:bg-sapphire-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sapphire-500 transition shadow-md">
                            <svg id="train-spinner" class="hidden animate-spin -ml-1 mr-2 h-5 w-5 text-white"
                                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                            </svg>
                            <span id="train-btn-text">Train Model</span>
                        </button>
                    </div>

                    <!-- Collapsible Data & Advanced (Preserved Functionality) -->
                    <div class="border-t border-slate-100 pt-4 mt-2">
                        <details class="group">
                            <summary class="flex items-center justify-center gap-2 cursor-pointer text-xs font-medium text-slate-400 hover:text-slate-600 transition select-none">
                                <span>Observation Data &amp; Advanced Init</span>
                                <svg class="w-3 h-3 transition group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </summary>
                            <div class="mt-4 space-y-4 p-4 bg-slate-50 rounded border border-slate-100 text-sm">
                                <div>
                                    <label class="block font-medium mb-1 text-slate-700 text-xs">Observation Sequence</label>
                                    <textarea id="observations" rows="2" class="w-full text-xs font-mono border-gray-300 rounded focus:ring-sapphire-500 focus:border-sapphire-500">0, 1, 2, 0, 0, 1, 2, 1, 0, 2, 2, 0, 1, 0, 1, 2, 2, 0, 1, 1, 0, 2, 0, 1, 2, 0, 0, 1, 2, 1, 0, 2, 2, 0, 1, 0, 1, 2, 2, 0, 1, 1, 0, 2, 0, 1, 2, 0, 0, 1</textarea>
                                </div>
                                <div class="flex gap-2">
                                    <button type="button" id="preset-weather" class="px-3 py-1 bg-white border border-slate-200 rounded hover:bg-slate-50 text-xs">Weather Preset</button>
                                    <button type="button" id="preset-dna" class="px-3 py-1 bg-white border border-slate-200 rounded hover:bg-slate-50 text-xs">DNA Preset</button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 border-t border-slate-200 pt-4">
                                     <div><label class="block text-xs font-semibold mb-1">Init A</label><textarea id="init-a" rows="2" class="w-full text-xs font-mono border-gray-300 rounded"></textarea></div>
                                     <div><label class="block text-xs font-semibold mb-1">Init B</label><textarea id="init-b" rows="2" class="w-full text-xs font-mono border-gray-300 rounded"></textarea></div>
                                     <div><label class="block text-xs font-semibold mb-1">Init Pi</label><input type="text" id="init-pi" class="w-full text-xs font-mono border-gray-300 rounded"></div>
                                </div>
                            </div>
                        </details>
                    </div>
                </form>
            </div>
        </section>

        <!-- ══════════════ 3. LIVE METRICS (Redesigned) ══════════════ -->
        <section id="results-section" class="hidden">
            <div class="card bg-white border border-slate-200 shadow-sm rounded-lg overflow-hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 divide-y md:divide-y-0 md:divide-x divide-slate-100">
                    <!-- Iteration -->
                    <div class="p-6 text-center">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">Iteration</p>
                        <p id="metric-iter" class="text-5xl font-mono font-bold text-slate-800 leading-none">&mdash;</p>
                    </div>
                    <!-- Log Likelihood -->
                    <div class="p-6 text-center">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">Log-Likelihood</p>
                        <div class="flex flex-col items-center justify-center h-full">
                             <p id="metric-ll" class="text-4xl font-mono font-bold text-slate-800 leading-none mb-1">&mdash;</p>
                             <p id="metric-delta" class="text-xs font-mono text-slate-400 hidden">&mdash;</p>
                        </div>
                    </div>
                    <!-- Status -->
                    <div class="p-6 text-center flex flex-col items-center justify-center">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">Status</p>
                        <div class="flex items-center gap-2">
                             <span id="metric-status" class="text-3xl font-bold text-emerald-500">Ready</span>
                             <!-- <div class="bg-emerald-100 text-emerald-700 rounded-full p-1"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg></div> -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ══════════════ CHART GRID ══════════════ -->
        <!-- Row 1: Convergence & Prob (Side by Side) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <section id="ll-section" class="hidden">
                <p class="text-sm font-semibold text-slate-800 mb-3 ml-1">Log-Likelihood Convergence</p>
                <div class="card p-4 bg-white border border-slate-200 shadow-sm rounded-lg h-full">
                    <div id="ll-chart" style="width:100%; height:280px;"></div>
                </div>
            </section>
            <section id="prob-section" class="hidden">
                <p class="text-sm font-semibold text-slate-800 mb-3 ml-1">Observation Probability (P(O|A))</p>
                <div class="card p-4 bg-white border border-slate-200 shadow-sm rounded-lg h-full">
                    <div id="prob-chart" style="width:100%; height:280px;"></div>
                </div>
            </section>
        </div>

        <!-- Row 2: Diagram (Full Width) -->
        <section id="diagram-section" class="hidden">
            <p class="text-sm font-semibold text-slate-800 mb-3 ml-1">State Transition Diagram</p>
            <div class="card p-6 bg-white border border-slate-200 shadow-sm rounded-lg">
                <div id="state-diagram-container" class="hmm-canvas w-full flex justify-center items-center" style="min-height: 350px;"></div>
                
                <div class="hmm-controls mt-6 pt-4 border-t border-slate-100 flex justify-center items-center gap-2">
                       <button id="hmm-first" class="p-2 hover:bg-slate-100 rounded text-slate-500">⏮</button>
                       <button id="hmm-back" class="p-2 hover:bg-slate-100 rounded text-slate-500">⏪</button>
                       <button id="hmm-play" class="p-2 hover:bg-slate-100 rounded text-sapphire-600 font-bold text-lg">▶</button>
                       <button id="hmm-fwd" class="p-2 hover:bg-slate-100 rounded text-slate-500">⏩</button>
                       <button id="hmm-last" class="p-2 hover:bg-slate-100 rounded text-slate-500">⏭</button>
                       <div class="w-px h-6 bg-slate-200 mx-2"></div>
                       <select id="hmm-speed" class="text-xs border-none bg-slate-50 rounded px-2 py-1"><option value="1">1×</option><option value="2">2×</option></select>
                       <span id="hmm-iter-label" class="text-xs font-mono text-slate-500 min-w-[60px] text-center">Iter 0</span>
                       <input id="hmm-timeline" type="range" class="w-32 accent-sapphire-500">
                       <button id="hmm-particles" class="text-xs p-1 ml-2 text-sapphire-500">✦</button>
                </div>
                <!-- Hidden Inspector Hook -->
                <div id="hmm-inspector" class="hidden"></div>
            </div>
        </section>

        <!-- Row 3: Matrices (A, B, Pi) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
             <!-- Wrap A and B in the heatmaps-section ID but display as contents to use the parent grid -->
             <section id="heatmaps-section" class="hidden contents">
                 <div>
                    <p class="text-sm font-semibold text-slate-800 mb-3 ml-1">Transition Matrix A</p>
                    <div class="card p-4 bg-white border border-slate-200 shadow-sm rounded-lg flex justify-center items-start min-h-[250px]">
                        <div id="heatmap-A"></div>
                    </div>
                 </div>
                 <div>
                    <p class="text-sm font-semibold text-slate-800 mb-3 ml-1">Emission Matrix B</p>
                    <div class="card p-4 bg-white border border-slate-200 shadow-sm rounded-lg flex justify-center items-start min-h-[250px]">
                        <div id="heatmap-B"></div>
                    </div>
                 </div>
             </section>
             
             <section id="pi-section" class="hidden">
                 <p class="text-sm font-semibold text-slate-800 mb-3 ml-1">Initial Distribution &pi;</p>
                 <div class="card p-4 bg-white border border-slate-200 shadow-sm rounded-lg min-h-[250px] flex flex-col justify-center">
                    <div id="pi-bars" class="space-y-4 w-full"></div>
                 </div>
             </section>
        </div>

        <!-- Row 4: Evolution & Log -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <section id="evolution-section" class="hidden">
                <p class="text-sm font-semibold text-slate-800 mb-3 ml-1">Parameter Evolution</p>
                <div class="card p-4 bg-white border border-slate-200 shadow-sm rounded-lg h-[350px]">
                     <div id="evolution-chart" style="width:100%; height:100%;"></div>
                </div>
            </section>
            
            <section id="iterlog-section" class="hidden">
                <p class="text-sm font-semibold text-slate-800 mb-3 ml-1">Iteration Log</p>
                <div class="card bg-white border border-slate-200 shadow-sm rounded-lg h-[350px] flex flex-col">
                    <div class="overflow-auto flex-1 p-0">
                        <table class="iter-table w-full text-left" id="iter-table">
                            <thead><tr id="iter-table-head" class="bg-slate-50 text-slate-500 sticky top-0"></tr></thead>
                            <tbody id="iter-table-body" class="text-xs font-mono text-slate-600 divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>

        <!-- Extra / Bottom / Hidden by Default -->
        <section id="error-section" class="hidden"><div class="card p-4"><div id="error-chart"></div></div></section>
        <section id="comp-section" class="hidden"><div class="card p-4"><div id="comp-chart"></div></div></section>
        <section id="intermediate-section" class="hidden mt-8">
             <p class="section-title mb-3">Intermediate Variables</p>
             <div class="card p-4 text-xs">
                <div class="flex gap-2 mb-2">
                    <button id="btn-show-alpha">Alpha</button>
                    <button id="btn-show-beta">Beta</button>
                    <button id="btn-show-gamma">Gamma</button>
                </div>
                <div id="intermediate-container" class="overflow-auto"></div>
             </div>
        </section>
        <section id="summary-section" class="hidden mt-8"></section>

    </main>

    <!-- ══════════════ FOOTER ══════════════ -->
    <footer class="border-t border-slate-100 mt-12 bg-white">
        <div class="max-w-7xl mx-auto px-6 py-6 flex items-center justify-between text-xs text-slate-400">
            <span>HMM Baum&ndash;Welch Engine &middot; v1.0</span>
            <div class="hidden md:block">Flask-SocketIO &middot; D3.js &middot; Plotly.js</div>
        </div>
    </footer>

    <div id="d3-tooltip" class="d3-tooltip" style="display:none;"></div>

    <!-- JAVASCRIPT -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="/static/js/hmm_diagram.js?v=custom2"></script>
    <script>
            (function () {
                'use strict';

                // ── State ──
                let socket = null;
                let llData = { x: [], y: [] };
                let probData = { x: [], y: [] };
                let errorData = { x: [], y: [] };
                let prevLL = null;
                let nStates = 2;
                let nObsSymbols = 3;
                let evolutionData = {};
                let hmmDiagram = null;
                // hmmDiagram3D removed
                let lastData = null;
                let iterCount = 0;

                // ── DOM ──
                const form = document.getElementById('train-form');
                const trainBtn = document.getElementById('train-btn');
                const trainBtnText = document.getElementById('train-btn-text');
                const trainSpinner = document.getElementById('train-spinner');
                const statusBadge = document.getElementById('status-badge');
                const statusText = document.getElementById('status-text');
                const tooltip = document.getElementById('d3-tooltip');

                const SECTIONS = ['results-section', 'll-section', 'prob-section', 'error-section', 'comp-section', 'diagram-section',
                    'heatmaps-section', 'pi-section', 'evolution-section', 'iterlog-section', 'intermediate-section'];

                let currentInterimView = 'alpha';
                document.getElementById('btn-show-alpha').addEventListener('click', () => setInterimView('alpha'));
                document.getElementById('btn-show-beta').addEventListener('click', () => setInterimView('beta'));
                document.getElementById('btn-show-gamma').addEventListener('click', () => setInterimView('gamma'));

                function setInterimView(view) {
                    currentInterimView = view;
                    // Update buttons
                    ['alpha', 'beta', 'gamma'].forEach(v => {
                        const btn = document.getElementById(`btn-show-${v}`);
                        if (v === view) {
                            btn.className = 'text-xs font-semibold px-3 py-1 rounded bg-sapphire-100 text-sapphire-700';
                        } else {
                            btn.className = 'text-xs font-semibold px-3 py-1 rounded hover:bg-slate-100 text-slate-600';
                        }
                    });
                    // Refresh table if data exists
                    if (lastData) updateIntermediate(lastData.alpha, lastData.beta, lastData.gamma);
                }

                // ── Presets ──
                document.getElementById('preset-weather').addEventListener('click', () => {
                    document.getElementById('n-states').value = 2;
                    document.getElementById('observations').value =
                        '0, 1, 2, 0, 0, 1, 2, 1, 0, 2, 2, 0, 1, 0, 1, 2, 2, 0, 1, 1, ' +
                        '0, 2, 0, 1, 2, 0, 0, 1, 2, 1, 0, 2, 2, 0, 1, 0, 1, 2, 2, 0, ' +
                        '1, 1, 0, 2, 0, 1, 2, 0, 0, 1, 2, 1, 0, 2, 2, 0, 1, 0, 1, 2';
                    document.getElementById('max-iter').value = 100;
                    document.getElementById('tolerance').value = '1e-6';
                });
                document.getElementById('preset-dna').addEventListener('click', () => {
                    document.getElementById('n-states').value = 3;
                    document.getElementById('observations').value =
                        '0, 1, 2, 3, 0, 1, 0, 2, 3, 1, 2, 0, 3, 1, 2, 0, 0, 1, 3, 2, ' +
                        '1, 0, 3, 2, 1, 0, 2, 3, 0, 1, 2, 3, 0, 1, 0, 2, 3, 1, 2, 0, ' +
                        '3, 1, 2, 0, 0, 1, 3, 2, 1, 0, 3, 2, 1, 0, 2, 3, 0, 1, 2, 3';
                    document.getElementById('max-iter').value = 150;
                    document.getElementById('tolerance').value = '1e-8';
                });

                // ── Status helpers ──
                function setStatus(status) {
                    const dot = statusBadge.querySelector('span:first-child');
                    statusText.textContent = status;
                    dot.innerHTML = '';
                    dot.style.position = '';
                    if (status === 'Training') {
                        dot.className = 'w-2 h-2 rounded-full bg-sapphire-500 status-pulse';
                        dot.innerHTML = '<span class="absolute w-2 h-2 rounded-full bg-sapphire-400 pulse-dot"></span>';
                        dot.style.position = 'relative';
                        statusBadge.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full border border-sapphire-200 text-xs font-medium text-sapphire-600 bg-sapphire-50';
                    } else if (status === 'Converged') {
                        dot.className = 'w-2 h-2 rounded-full bg-emerald-500';
                        statusBadge.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full border border-emerald-300 text-xs font-medium text-emerald-700 bg-emerald-50';
                    } else {
                        dot.className = 'w-2 h-2 rounded-full bg-slate-400';
                        statusBadge.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full border border-academic-border text-xs font-medium text-academic-muted bg-academic-bg';
                    }
                }

                function setTraining(active) {
                    trainBtn.disabled = active;
                    trainSpinner.classList.toggle('hidden', !active);
                    trainBtnText.textContent = active ? 'Training...' : 'Train Model';
                }

                // ══════════════════════════════════════════════════
                //  FORM SUBMIT → WebSocket
                // ══════════════════════════════════════════════════
                form.addEventListener('submit', function (e) {
                    e.preventDefault();

                    nStates = parseInt(document.getElementById('n-states').value, 10);
                    const obsText = document.getElementById('observations').value;
                    const maxIter = parseInt(document.getElementById('max-iter').value, 10);
                    const tol = parseFloat(document.getElementById('tolerance').value);

                    const observations = obsText.split(',').map(s => parseInt(s.trim(), 10)).filter(n => !isNaN(n));
                    if (observations.length < 2) { alert('Need at least 2 observations.'); return; }
                    nObsSymbols = Math.max(...observations) + 1;

                    // Reset
                    llData = { x: [], y: [] };
                    probData = { x: [], y: [] };
                    errorData = { x: [], y: [] };
                    prevLL = null;
                    evolutionData = {};
                    if (hmmDiagram) hmmDiagram.reset();
                    hmmDiagram = new HMMDiagram('#state-diagram-container', '#hmm-inspector');
                    hmmDiagram.wireControls({
                        btnFirst: document.getElementById('hmm-first'),
                        btnBack: document.getElementById('hmm-back'),
                        btnPlay: document.getElementById('hmm-play'),
                        btnForward: document.getElementById('hmm-fwd'),
                        btnLast: document.getElementById('hmm-last'),
                        speedSelect: document.getElementById('hmm-speed'),
                        timeline: document.getElementById('hmm-timeline'),
                        iterLabel: document.getElementById('hmm-iter-label'),
                        btnParticles: document.getElementById('hmm-particles'),
                    });
                    lastData = null;
                    iterCount = 0;

                    for (let i = 0; i < nStates; i++)
                        for (let j = 0; j < nStates; j++)
                            evolutionData[`A[${i}][${j}]`] = { x: [], y: [] };

                    // Show sections
                    SECTIONS.forEach(id => document.getElementById(id).classList.remove('hidden'));
                    document.getElementById('summary-section').classList.add('hidden');
                    document.getElementById('metric-iter').textContent = '\u2014';
                    document.getElementById('metric-ll').textContent = '\u2014';
                    document.getElementById('metric-delta').textContent = '\u2014';
                    document.getElementById('metric-status').textContent = 'Starting';
                    document.getElementById('metric-status').className = 'text-2xl font-semibold text-sapphire-600';

                    // Build iteration log table header
                    buildIterTableHeader();
                    document.getElementById('iter-table-body').innerHTML = '';

                    setStatus('Training');
                    setTraining(true);
                    initLLChart();
                    initProbChart();
                    initErrorChart();
                    initCompChart();
                    initEvolutionChart();

                    // Connect
                    if (socket) socket.disconnect();
                    socket = io();

                    socket.on('connect', () => {
                        // Gather initialization params
                        const rawA = document.getElementById('init-a').value.trim();
                        const rawB = document.getElementById('init-b').value.trim();
                        const rawPi = document.getElementById('init-pi').value.trim();
                        let initParams = null;

                        try {
                            if (rawA || rawB || rawPi) {
                                initParams = {};
                                if (rawA) initParams.A = JSON.parse(rawA);
                                if (rawB) initParams.B = JSON.parse(rawB);
                                if (rawPi) initParams.pi = JSON.parse(rawPi);
                            }
                        } catch (err) {
                            alert("Invalid JSON in Advanced Settings: " + err.message);
                            setTraining(false);
                            return;
                        }

                        socket.emit('start_training', {
                            n_states: nStates,
                            observations: observations,
                            max_iterations: maxIter,
                            tolerance: tol,
                            init_params: initParams
                        });
                    });

                    socket.on('training_update', function (data) {
                        iterCount++;
                        lastData = data;
                        updateMetrics(data);
                        updateLLChart(data);
                        updateProbChart(data);
                        updateErrorChart(data);
                        updateCompChart(data);
                        if (hmmDiagram) hmmDiagram.feedIteration(data);
                        // hmmDiagram3D removed
                        updateHeatmaps(data.A, data.B);
                        updatePi(data.pi);
                        updateEvolution(data);
                        appendIterRow(data);
                        updateIntermediate(data.alpha, data.beta, data.gamma);
                    });

                    socket.on('training_complete', function (data) {
                        setTraining(false);
                        if (data.converged) {
                            setStatus('Converged');
                            document.getElementById('metric-status').textContent = 'Converged';
                            document.getElementById('metric-status').className = 'text-2xl font-semibold text-emerald-600';
                        } else {
                            setStatus('Max Iterations');
                            document.getElementById('metric-status').textContent = 'Max Iter';
                            document.getElementById('metric-status').className = 'text-2xl font-semibold text-amber-600';
                        }
                        // Build final summary
                        if (lastData) buildFinalSummary(lastData, data);
                    });

                    socket.on('training_error', function (data) {
                        setTraining(false);
                        setStatus('Error');
                        alert('Training error: ' + data.error);
                    });
                });

                // ══════════════════════════════════════════════════
                //  3. METRICS
                // ══════════════════════════════════════════════════
                function updateMetrics(data) {
                    document.getElementById('metric-iter').textContent = data.iteration;
                    document.getElementById('metric-ll').textContent = data.log_likelihood.toFixed(4);
                    const delta = prevLL !== null ? (data.log_likelihood - prevLL) : 0;
                    document.getElementById('metric-delta').textContent = (delta >= 0 ? '+' : '') + delta.toExponential(3);
                    document.getElementById('metric-status').textContent = data.converged ? 'Converged' : 'Running';
                    if (data.converged) {
                        document.getElementById('metric-status').className = 'text-2xl font-semibold text-emerald-600';
                    }
                    prevLL = data.log_likelihood;
                }

                // ══════════════════════════════════════════════════
                //  4. LOG-LIKELIHOOD CHART
                // ══════════════════════════════════════════════════
                function initLLChart() {
                    Plotly.newPlot('ll-chart', [{
                        x: [], y: [], mode: 'lines',
                        line: { color: '#2563EB', width: 2 },
                        hovertemplate: 'Iteration %{x}<br>log P(O|\u03bb): %{y:.6f}<extra></extra>'
                    }], {
                        margin: { t: 10, r: 30, b: 45, l: 75 },
                        xaxis: { title: { text: 'Iteration', font: { family: 'Inter', size: 12, color: '#64748b' } }, gridcolor: '#f1f0ed', zeroline: false },
                        yaxis: { title: { text: 'log P(O|\u03bb)', font: { family: 'Inter', size: 12, color: '#64748b' } }, gridcolor: '#f1f0ed', zeroline: false },
                        paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                        font: { family: 'JetBrains Mono', size: 10, color: '#64748b' },
                        hovermode: 'x unified'
                    }, { responsive: true, displayModeBar: false });
                }

                function updateLLChart(data) {
                    Plotly.extendTraces('ll-chart', { x: [[data.iteration]], y: [[data.log_likelihood]] }, [0]);
                }

                // ══════════════════════════════════════════════════
                //  4b. P(O|lambda) CHART
                // ══════════════════════════════════════════════════
                function initProbChart() {
                    Plotly.newPlot('prob-chart', [{
                        x: [], y: [], mode: 'lines',
                        line: { color: '#059669', width: 2 },
                        hovertemplate: 'Iteration %{x}<br>P(O|\u03bb): %{y:.6e}<extra></extra>'
                    }], {
                        margin: { t: 10, r: 30, b: 45, l: 75 },
                        xaxis: { title: { text: 'Iteration', font: { family: 'Inter', size: 12, color: '#64748b' } }, gridcolor: '#f1f0ed', zeroline: false },
                        yaxis: { title: { text: 'P(O|\u03bb)', font: { family: 'Inter', size: 12, color: '#64748b' } }, gridcolor: '#f1f0ed', zeroline: false, exponentformat: 'e' },
                        paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                        font: { family: 'JetBrains Mono', size: 10, color: '#64748b' },
                        hovermode: 'x unified'
                    }, { responsive: true, displayModeBar: false });
                }

                function updateProbChart(data) {
                    const prob = Math.exp(data.log_likelihood);
                    Plotly.extendTraces('prob-chart', { x: [[data.iteration]], y: [[prob]] }, [0]);
                }

                // ══════════════════════════════════════════════════
                //  4c. ERROR CHART
                // ══════════════════════════════════════════════════
                function initErrorChart() {
                    Plotly.newPlot('error-chart', [{
                        x: [], y: [], mode: 'lines',
                        line: { color: '#EF4444', width: 2 },
                        hovertemplate: 'Iteration %{x}<br>Loss: %{y:.4f}<extra></extra>'
                    }], {
                        margin: { t: 10, r: 30, b: 45, l: 75 },
                        xaxis: { title: { text: 'Iteration', font: { family: 'Inter', size: 12, color: '#64748b' } }, gridcolor: '#f1f0ed', zeroline: false },
                        yaxis: { title: { text: 'NLL (-log P)', font: { family: 'Inter', size: 12, color: '#64748b' } }, gridcolor: '#f1f0ed', zeroline: false },
                        paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                        font: { family: 'JetBrains Mono', size: 10, color: '#64748b' },
                        hovermode: 'x unified'
                    }, { responsive: true, displayModeBar: false });
                }

                function updateErrorChart(data) {
                    // Use Negative Log Likelihood as "Error" (Loss)
                    const loss = -data.log_likelihood;
                    Plotly.extendTraces('error-chart', { x: [[data.iteration]], y: [[loss]] }, [0]);
                }

                // ══════════════════════════════════════════════════
                //  4d. PROB COMPLEMENT CHART
                // ══════════════════════════════════════════════════
                function initCompChart() {
                    Plotly.newPlot('comp-chart', [{
                        x: [], y: [], mode: 'lines',
                        line: { color: '#D946EF', width: 2 }, // Fuchsia
                        hovertemplate: 'Iter %{x}<br>1 - P: %{y:.6f}<extra></extra>'
                    }], {
                        margin: { t: 10, r: 30, b: 45, l: 75 },
                        xaxis: { title: { text: 'Model Version (\u03bb)', font: { family: 'Inter', size: 12, color: '#64748b' } }, gridcolor: '#f1f0ed', zeroline: false },
                        yaxis: { title: { text: '1 - P(O|\u03bb)', font: { family: 'Inter', size: 12, color: '#64748b' } }, gridcolor: '#f1f0ed', zeroline: false },
                        paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                        font: { family: 'JetBrains Mono', size: 10, color: '#64748b' },
                        hovermode: 'x unified'
                    }, { responsive: true, displayModeBar: false });
                }

                function updateCompChart(data) {
                    const prob = Math.exp(data.log_likelihood);
                    const comp = 1 - prob;
                    Plotly.extendTraces('comp-chart', { x: [[data.iteration]], y: [[comp]] }, [0]);
                }

                // (State diagram handled by external HMMDiagram class)

                // ══════════════════════════════════════════════════
                //  6-7. HEATMAPS
                // ══════════════════════════════════════════════════
                function updateHeatmaps(A, B) {
                    renderHeatmap('heatmap-A', A, 'S', 'S');
                    renderHeatmap('heatmap-B', B, 'S', 'O');
                }

                function renderHeatmap(id, matrix, rPfx, cPfx) {
                    const el = document.getElementById(id);
                    const R = matrix.length, C = matrix[0].length;
                    const cs = 60;
                    let h = '<table class="border-collapse"><tr><td class="w-10"></td>';
                    for (let j = 0; j < C; j++)
                        h += `<td class="text-center text-xs font-medium text-academic-muted pb-2" style="width:${cs}px">${cPfx}${j}</td>`;
                    h += '</tr>';
                    for (let i = 0; i < R; i++) {
                        h += `<tr><td class="text-right text-xs font-medium text-academic-muted pr-3">${rPfx}${i}</td>`;
                        for (let j = 0; j < C; j++) {
                            const v = matrix[i][j];
                            const r = Math.round(255 - v * (255 - 37));
                            const g = Math.round(255 - v * (255 - 99));
                            const b = Math.round(255 - v * (255 - 235));
                            const tc = v > 0.55 ? '#fff' : '#1e293b';
                            h += `<td class="heatmap-cell text-center border border-slate-100"
                          style="width:${cs}px;height:${cs}px;background:rgb(${r},${g},${b});color:${tc};line-height:${cs}px;">
                          ${v.toFixed(3)}</td>`;
                        }
                        h += '</tr>';
                    }
                    h += '</table>';
                    el.innerHTML = h;
                }

                // ══════════════════════════════════════════════════
                //  8. PI BARS
                // ══════════════════════════════════════════════════
                function updatePi(pi) {
                    const el = document.getElementById('pi-bars');
                    let h = '';
                    for (let i = 0; i < pi.length; i++) {
                        const pct = (pi[i] * 100).toFixed(1);
                        h += `<div class="flex items-center gap-3">
                    <span class="text-xs font-medium text-slate-600 w-8">S${i}</span>
                    <div class="flex-1 bg-slate-100 rounded h-7 overflow-hidden">
                        <div class="pi-bar" style="width:${pct}%; min-width:2px;"></div>
                    </div>
                    <span class="font-mono-num text-xs text-slate-700 w-16 text-right">${pi[i].toFixed(4)}</span>
                </div>`;
                    }
                    el.innerHTML = h;
                }

                // ══════════════════════════════════════════════════
                //  9. PARAMETER EVOLUTION
                // ══════════════════════════════════════════════════
                const evoColors = ['#2563EB', '#7C3AED', '#DC2626', '#059669', '#D97706', '#0891B2', '#BE185D', '#6D28D9', '#CA8A04', '#166534'];

                function initEvolutionChart() {
                    const traces = [];
                    let idx = 0;
                    for (let i = 0; i < nStates; i++) {
                        for (let j = 0; j < nStates; j++) {
                            traces.push({
                                x: [], y: [], mode: 'lines', name: `A[${i}][${j}]`,
                                line: { color: evoColors[idx % evoColors.length], width: 1.5 },
                                hovertemplate: `A[${i}][${j}] = %{y:.4f}<extra></extra>`
                            });
                            idx++;
                        }
                    }
                    Plotly.newPlot('evolution-chart', traces, {
                        margin: { t: 10, r: 30, b: 45, l: 60 },
                        xaxis: { title: { text: 'Iteration', font: { family: 'Inter', size: 12, color: '#64748b' } }, gridcolor: '#f1f0ed', zeroline: false },
                        yaxis: { title: { text: 'Probability', font: { family: 'Inter', size: 12, color: '#64748b' } }, gridcolor: '#f1f0ed', zeroline: false, range: [0, 1] },
                        paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                        font: { family: 'JetBrains Mono', size: 10, color: '#64748b' },
                        legend: { font: { family: 'JetBrains Mono', size: 10 }, orientation: 'h', y: -0.22 },
                        hovermode: 'x unified'
                    }, { responsive: true, displayModeBar: false });
                }

                function updateEvolution(data) {
                    const A = data.A;
                    const xU = [], yU = [], indices = [];
                    let idx = 0;
                    for (let i = 0; i < A.length; i++)
                        for (let j = 0; j < A[i].length; j++) {
                            xU.push([data.iteration]); yU.push([A[i][j]]); indices.push(idx++);
                        }
                    Plotly.extendTraces('evolution-chart', { x: xU, y: yU }, indices);
                }

                // ══════════════════════════════════════════════════
                //  10. ITERATION LOG TABLE
                // ══════════════════════════════════════════════════
                function buildIterTableHeader() {
                    let h = '<th>Iter</th><th>Log-Likelihood</th><th>\u0394LL</th>';
                    for (let i = 0; i < nStates; i++)
                        for (let j = 0; j < nStates; j++)
                            h += `<th>A[${i}][${j}]</th>`;
                    for (let i = 0; i < nStates; i++)
                        for (let k = 0; k < nObsSymbols; k++)
                            h += `<th>B[${i}][${k}]</th>`;
                    for (let i = 0; i < nStates; i++)
                        h += `<th>\u03c0[${i}]</th>`;
                    document.getElementById('iter-table-head').innerHTML = h;
                }

                let prevLLForTable = null;
                function appendIterRow(data) {
                    const tbody = document.getElementById('iter-table-body');
                    const delta = prevLLForTable !== null ? (data.log_likelihood - prevLLForTable) : 0;
                    prevLLForTable = data.log_likelihood;

                    let cells = `<td>${data.iteration}</td>`;
                    cells += `<td>${data.log_likelihood.toFixed(6)}</td>`;
                    cells += `<td>${(delta >= 0 ? '+' : '')}${delta.toExponential(3)}</td>`;
                    for (let i = 0; i < data.A.length; i++)
                        for (let j = 0; j < data.A[i].length; j++)
                            cells += `<td>${data.A[i][j].toFixed(4)}</td>`;
                    for (let i = 0; i < data.B.length; i++)
                        for (let k = 0; k < data.B[i].length; k++)
                            cells += `<td>${data.B[i][k].toFixed(4)}</td>`;
                    for (let i = 0; i < data.pi.length; i++)
                        cells += `<td>${data.pi[i].toFixed(4)}</td>`;

                    const tr = document.createElement('tr');
                    tr.innerHTML = cells;
                    tbody.appendChild(tr);

                    // Auto-scroll to bottom
                    const wrapper = tbody.closest('div');
                    if (wrapper) wrapper.scrollTop = wrapper.scrollHeight;
                }

                // ══════════════════════════════════════════════════
                //  10.5 INTERMEDIATE VARS
                // ══════════════════════════════════════════════════
                function updateIntermediate(alpha, beta, gamma) {
                    if (!alpha || !beta || !gamma) return;
                    
                    let data = [];
                    if (currentInterimView === 'alpha') data = alpha;
                    else if (currentInterimView === 'beta') data = beta;
                    else if (currentInterimView === 'gamma') data = gamma;

                    // Limit to 20 rows
                    const limit = Math.min(20, data.length);
                    const T = data.length;
                    const N = data[0].length;

                    let html = '<table class="iter-table w-full text-left border-collapse border border-slate-200">';
                    
                    // Header
                    html += '<thead><tr><th class="border border-slate-200 bg-slate-50">t</th>';
                    for(let i=0; i<N; i++) html += `<th class="border border-slate-200 bg-slate-50 text-center">S${i}</th>`;
                    html += '</tr></thead><tbody>';

                    for(let t=0; t<limit; t++) {
                        html += `<tr><td class="border border-slate-200 font-semibold bg-slate-50 text-center">${t}</td>`;
                        for(let i=0; i<N; i++) {
                            // Highlight large values
                            const val = data[t][i];
                            const isLarge = val > (1.0/N);
                            const style = isLarge ? 'font-weight:600; color:#1e293b;' : 'color:#94a3b8;';
                            html += `<td class="border border-slate-200 text-center" style="${style}">${val.toExponential(4)}</td>`;
                        }
                        html += '</tr>';
                    }
                    html += '</tbody></table>';
                    
                    if (T > limit) {
                         html += `<p class="text-[10px] text-slate-400 mt-1 text-center">... and ${T - limit} more time steps ...</p>`;
                    }

                    document.getElementById('intermediate-container').innerHTML = html;
                }

                // ══════════════════════════════════════════════════
                //  11. FINAL SUMMARY TABLE
                // ══════════════════════════════════════════════════
                function buildFinalSummary(lastData, completionData) {
                    const sec = document.getElementById('summary-section');
                    sec.classList.remove('hidden');

                    const A = lastData.A, B = lastData.B, pi = lastData.pi;
                    let html = '';

                    // Stats bar
                    html += `<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-slate-50 rounded p-3">
                <p class="text-xs text-academic-muted mb-0.5">Total Iterations</p>
                <p class="font-mono-num font-semibold text-lg">${completionData.n_iterations}</p>
            </div>
            <div class="bg-slate-50 rounded p-3">
                <p class="text-xs text-academic-muted mb-0.5">Final log P(O|&lambda;)</p>
                <p class="font-mono-num font-semibold text-lg">${completionData.final_log_likelihood.toFixed(6)}</p>
            </div>
            <div class="bg-slate-50 rounded p-3">
                <p class="text-xs text-academic-muted mb-0.5">Final P(O|&lambda;)</p>
                <p class="font-mono-num font-semibold text-lg">${Math.exp(completionData.final_log_likelihood).toExponential(4)}</p>
            </div>
            <div class="bg-slate-50 rounded p-3">
                <p class="text-xs text-academic-muted mb-0.5">Converged</p>
                <p class="font-semibold text-lg ${completionData.converged ? 'text-emerald-600' : 'text-amber-600'}">${completionData.converged ? 'Yes' : 'No (max iter)'}</p>
            </div>
        </div>`;

                    // ── Transition Matrix A ──
                    html += '<h3 class="text-sm font-semibold text-slate-700 mb-2">Transition Matrix A</h3>';
                    html += '<div class="overflow-x-auto mb-5"><table class="iter-table border-collapse border border-slate-200">';
                    html += '<tr><th class="border border-slate-200 bg-slate-50"></th>';
                    for (let j = 0; j < A[0].length; j++) html += `<th class="border border-slate-200 bg-slate-50 text-center">S${j}</th>`;
                    html += '</tr>';
                    for (let i = 0; i < A.length; i++) {
                        html += `<tr><td class="border border-slate-200 bg-slate-50 font-semibold text-center">S${i}</td>`;
                        for (let j = 0; j < A[i].length; j++)
                            html += `<td class="border border-slate-200 text-center">${A[i][j].toFixed(6)}</td>`;
                        html += '</tr>';
                    }
                    html += '</table></div>';

                    // ── Emission Matrix B ──
                    html += '<h3 class="text-sm font-semibold text-slate-700 mb-2">Emission Matrix B</h3>';
                    html += '<div class="overflow-x-auto mb-5"><table class="iter-table border-collapse border border-slate-200">';
                    html += '<tr><th class="border border-slate-200 bg-slate-50"></th>';
                    for (let k = 0; k < B[0].length; k++) html += `<th class="border border-slate-200 bg-slate-50 text-center">O${k}</th>`;
                    html += '</tr>';
                    for (let i = 0; i < B.length; i++) {
                        html += `<tr><td class="border border-slate-200 bg-slate-50 font-semibold text-center">S${i}</td>`;
                        for (let k = 0; k < B[i].length; k++)
                            html += `<td class="border border-slate-200 text-center">${B[i][k].toFixed(6)}</td>`;
                        html += '</tr>';
                    }
                    html += '</table></div>';

                    // ── Initial Distribution ──
                    html += '<h3 class="text-sm font-semibold text-slate-700 mb-2">Initial Distribution &pi;</h3>';
                    html += '<div class="overflow-x-auto"><table class="iter-table border-collapse border border-slate-200"><tr>';
                    for (let i = 0; i < pi.length; i++) html += `<th class="border border-slate-200 bg-slate-50 text-center">&pi;(S${i})</th>`;
                    html += '</tr><tr>';
                    for (let i = 0; i < pi.length; i++) html += `<td class="border border-slate-200 text-center">${pi[i].toFixed(6)}</td>`;
                    html += '</tr></table></div>';

                    document.getElementById('summary-content').innerHTML = html;

                    // Scroll to summary
                    sec.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }

            })();
    </script>


</body>

</html>