<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Hidden Markov Model trainer with Baum-Welch algorithm ‚Äî interactive web UI.">
    <title>HMM Baum-Welch Trainer</title>
    <style>
        /* ‚îÄ‚îÄ‚îÄ Design Tokens ‚îÄ‚îÄ‚îÄ */
        :root {
            --clr-bg: #0f1117;
            --clr-surface: #1a1d2e;
            --clr-surface2: #242840;
            --clr-primary: #2e86ab;
            --clr-accent: #f18f01;
            --clr-success: #2ca58d;
            --clr-magenta: #a23b72;
            --clr-text: #e8e8f0;
            --clr-muted: #8888a8;
            --clr-border: #333660;
            --font: 'Segoe UI', system-ui, -apple-system, sans-serif;
            --mono: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
            --radius: 12px;
            --shadow: 0 8px 32px rgba(0,0,0,.35);
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font);
            background: var(--clr-bg);
            color: var(--clr-text);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ */
        .header {
            background: linear-gradient(135deg, var(--clr-surface) 0%, var(--clr-surface2) 100%);
            border-bottom: 1px solid var(--clr-border);
            padding: 1.5rem 2rem;
            text-align: center;
        }
        .header h1 {
            font-size: 1.75rem;
            background: linear-gradient(90deg, var(--clr-primary), var(--clr-accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }
        .header p { color: var(--clr-muted); font-size: .9rem; margin-top: .25rem; }

        /* ‚îÄ‚îÄ‚îÄ Layout ‚îÄ‚îÄ‚îÄ */
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }

        .grid { display: grid; grid-template-columns: 380px 1fr; gap: 2rem; }
        @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

        /* ‚îÄ‚îÄ‚îÄ Card ‚îÄ‚îÄ‚îÄ */
        .card {
            background: var(--clr-surface);
            border: 1px solid var(--clr-border);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }
        .card h2 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            display: flex; align-items: center; gap: .5rem;
        }
        .card h2 .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--clr-primary); }

        /* ‚îÄ‚îÄ‚îÄ Form ‚îÄ‚îÄ‚îÄ */
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-size: .82rem; color: var(--clr-muted); margin-bottom: .35rem; }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: .6rem .8rem;
            background: var(--clr-surface2);
            border: 1px solid var(--clr-border);
            border-radius: 8px;
            color: var(--clr-text);
            font-family: var(--mono);
            font-size: .9rem;
            transition: border-color .2s;
        }
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--clr-primary);
            box-shadow: 0 0 0 3px rgba(46,134,171,.2);
        }
        textarea { resize: vertical; min-height: 60px; }

        .btn {
            display: inline-flex; align-items: center; gap: .5rem;
            padding: .7rem 1.8rem;
            border: none; border-radius: 8px;
            font-size: .95rem; font-weight: 600; cursor: pointer;
            transition: transform .15s, box-shadow .15s;
            width: 100%;
            justify-content: center;
        }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(0,0,0,.3); }
        .btn-primary { background: linear-gradient(135deg, var(--clr-primary), #1a6d8e); color: #fff; }
        .btn:disabled { opacity: .5; cursor: not-allowed; transform: none; }

        /* ‚îÄ‚îÄ‚îÄ Spinner ‚îÄ‚îÄ‚îÄ */
        .spinner { display: none; width: 18px; height: 18px; border: 2px solid rgba(255,255,255,.3);
                   border-top-color: #fff; border-radius: 50%; animation: spin .6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ‚îÄ‚îÄ‚îÄ Results ‚îÄ‚îÄ‚îÄ */
        .results { display: none; }
        .results.visible { display: block; }

        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: .75rem; margin-bottom: 1.5rem; }
        .stat {
            background: var(--clr-surface2);
            border-radius: 8px; padding: .8rem;
            text-align: center;
        }
        .stat .label { font-size: .75rem; color: var(--clr-muted); text-transform: uppercase; letter-spacing: .05em; }
        .stat .value { font-size: 1.2rem; font-weight: 700; margin-top: .2rem; }
        .stat .value.yes { color: var(--clr-success); }
        .stat .value.no { color: var(--clr-accent); }

        .plot-section { margin-bottom: 1.5rem; }
        .plot-section h3 { font-size: .95rem; margin-bottom: .75rem; color: var(--clr-muted); }
        .plot-section img, .plot-section .svg-container { max-width: 100%; border-radius: 8px; background: #fff; }
        .svg-container { padding: 1rem; overflow-x: auto; }

        .matrix-section { margin-bottom: 1.5rem; }
        .matrix-section h3 { font-size: .95rem; margin-bottom: .5rem; color: var(--clr-muted); }
        .matrix-table {
            width: 100%; border-collapse: collapse;
            font-family: var(--mono); font-size: .82rem;
        }
        .matrix-table th, .matrix-table td {
            padding: .45rem .6rem;
            border: 1px solid var(--clr-border);
            text-align: center;
        }
        .matrix-table th { background: var(--clr-surface2); color: var(--clr-primary); font-weight: 600; }
        .matrix-table td { background: var(--clr-surface); }

        /* ‚îÄ‚îÄ‚îÄ Error ‚îÄ‚îÄ‚îÄ */
        .error-msg { color: #e84855; background: rgba(232,72,85,.1); border-radius: 8px; padding: .8rem; margin-top: 1rem; display: none; }
        .error-msg.visible { display: block; }

        /* ‚îÄ‚îÄ‚îÄ Presets ‚îÄ‚îÄ‚îÄ */
        .presets { margin-bottom: 1rem; }
        .preset-btn {
            background: var(--clr-surface2); border: 1px solid var(--clr-border);
            color: var(--clr-text); padding: .4rem .8rem; border-radius: 6px;
            cursor: pointer; font-size: .8rem; margin-right: .35rem; transition: background .2s;
        }
        .preset-btn:hover { background: var(--clr-primary); }
    </style>
</head>
<body>
    <div class="header">
        <h1>üî¨ HMM Baum-Welch Trainer</h1>
        <p>Production-grade Hidden Markov Model engine with EM training</p>
    </div>

    <div class="container">
        <div class="grid">
            <!-- ‚îÄ‚îÄ‚îÄ Left: Controls ‚îÄ‚îÄ‚îÄ -->
            <div>
                <div class="card">
                    <h2><span class="dot"></span> Configuration</h2>

                    <div class="presets">
                        <label style="font-size:.75rem;color:var(--clr-muted);display:block;margin-bottom:.35rem;">Quick Presets</label>
                        <button class="preset-btn" id="presetWeather" type="button">‚òÄÔ∏è Weather</button>
                        <button class="preset-btn" id="presetCoin" type="button">ü™ô Coin</button>
                    </div>

                    <form id="trainForm">
                        <div class="form-group">
                            <label for="observations">Observation Sequence (comma-separated integers)</label>
                            <textarea id="observations" placeholder="0, 1, 0, 0, 1, 2, 1, 0, 0, 1">0, 1, 0, 0, 1, 2, 1, 0, 0, 1</textarea>
                        </div>
                        <div class="form-group">
                            <label for="nStates">Number of Hidden States</label>
                            <input id="nStates" type="number" value="2" min="1" max="20">
                        </div>
                        <div class="form-group">
                            <label for="nObs">Number of Observation Symbols</label>
                            <input id="nObs" type="number" value="3" min="1" max="50">
                        </div>
                        <div class="form-group">
                            <label for="maxIter">Max Iterations</label>
                            <input id="maxIter" type="number" value="200" min="1" max="5000">
                        </div>
                        <div class="form-group">
                            <label for="tolerance">Convergence Tolerance</label>
                            <input id="tolerance" type="text" value="1e-6">
                        </div>
                        <div class="form-group">
                            <label for="seed">Random Seed (optional)</label>
                            <input id="seed" type="number" value="42">
                        </div>
                        <button class="btn btn-primary" type="submit" id="trainBtn">
                            <span class="spinner" id="spinner"></span>
                            <span id="btnText">Train Model</span>
                        </button>
                    </form>

                    <div class="error-msg" id="errorMsg"></div>
                </div>
            </div>

            <!-- ‚îÄ‚îÄ‚îÄ Right: Results ‚îÄ‚îÄ‚îÄ -->
            <div>
                <div class="results" id="results">
                    <div class="card" style="margin-bottom:1.5rem;">
                        <h2><span class="dot" style="background:var(--clr-success)"></span> Training Summary</h2>
                        <div class="stat-grid">
                            <div class="stat">
                                <div class="label">Converged</div>
                                <div class="value" id="statConverged">‚Äî</div>
                            </div>
                            <div class="stat">
                                <div class="label">Iterations</div>
                                <div class="value" id="statIter">‚Äî</div>
                            </div>
                            <div class="stat">
                                <div class="label">Final Log-LL</div>
                                <div class="value" id="statLL">‚Äî</div>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="margin-bottom:1.5rem;">
                        <h2><span class="dot" style="background:var(--clr-accent)"></span> Convergence Curve</h2>
                        <div class="plot-section">
                            <img id="plotLL" alt="Log-Likelihood Curve">
                        </div>
                    </div>

                    <div class="card" style="margin-bottom:1.5rem;">
                        <h2><span class="dot" style="background:var(--clr-magenta)"></span> State Diagram</h2>
                        <div class="plot-section">
                            <div class="svg-container" id="stateDiagram"></div>
                        </div>
                    </div>

                    <div class="card" style="margin-bottom:1.5rem;">
                        <h2><span class="dot"></span> Transition Matrix A</h2>
                        <div class="plot-section">
                            <img id="plotA" alt="Transition Heatmap">
                        </div>
                        <div class="matrix-section">
                            <h3>Raw Values</h3>
                            <table class="matrix-table" id="tableA"></table>
                        </div>
                    </div>

                    <div class="card" style="margin-bottom:1.5rem;">
                        <h2><span class="dot"></span> Emission Matrix B</h2>
                        <div class="plot-section">
                            <img id="plotB" alt="Emission Heatmap">
                        </div>
                        <div class="matrix-section">
                            <h3>Raw Values</h3>
                            <table class="matrix-table" id="tableB"></table>
                        </div>
                    </div>

                    <div class="card">
                        <h2><span class="dot" style="background:var(--clr-success)"></span> Initial Distribution œÄ</h2>
                        <div class="matrix-section">
                            <table class="matrix-table" id="tablePi"></table>
                        </div>
                    </div>
                </div>

                <!-- Placeholder when no results -->
                <div class="card" id="placeholder" style="text-align:center;padding:4rem 2rem;">
                    <p style="font-size:2.5rem;margin-bottom:.5rem;">üß¨</p>
                    <p style="color:var(--clr-muted);">Configure parameters and click <strong>Train Model</strong> to begin.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ‚îÄ‚îÄ‚îÄ Preset Handlers ‚îÄ‚îÄ‚îÄ //
        document.getElementById('presetWeather').addEventListener('click', () => {
            document.getElementById('observations').value = '0, 1, 0, 0, 1, 2, 1, 0, 0, 1, 2, 2, 1, 0, 0';
            document.getElementById('nStates').value = '2';
            document.getElementById('nObs').value = '3';
        });
        document.getElementById('presetCoin').addEventListener('click', () => {
            document.getElementById('observations').value = '0, 0, 1, 0, 1, 1, 1, 0, 0, 0, 1, 1, 0, 1, 0, 0, 1, 1, 1, 0';
            document.getElementById('nStates').value = '2';
            document.getElementById('nObs').value = '2';
        });

        // ‚îÄ‚îÄ‚îÄ Form Submission ‚îÄ‚îÄ‚îÄ //
        document.getElementById('trainForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('trainBtn');
            const spinner = document.getElementById('spinner');
            const btnText = document.getElementById('btnText');
            const errorMsg = document.getElementById('errorMsg');
            const results = document.getElementById('results');
            const placeholder = document.getElementById('placeholder');

            // Parse observations.
            const obsText = document.getElementById('observations').value.trim();
            const observations = obsText.split(/[,\s]+/).map(Number);

            const payload = {
                observations: observations,
                n_states: parseInt(document.getElementById('nStates').value),
                n_obs_symbols: parseInt(document.getElementById('nObs').value),
                max_iterations: parseInt(document.getElementById('maxIter').value),
                tolerance: parseFloat(document.getElementById('tolerance').value),
                seed: document.getElementById('seed').value ? parseInt(document.getElementById('seed').value) : null,
            };

            btn.disabled = true;
            spinner.style.display = 'inline-block';
            btnText.textContent = 'Training‚Ä¶';
            errorMsg.classList.remove('visible');

            try {
                const res = await fetch('/api/train', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'Unknown error');
                }

                // ‚îÄ‚îÄ‚îÄ Populate Results ‚îÄ‚îÄ‚îÄ //
                document.getElementById('statConverged').textContent = data.converged ? '‚úì Yes' : '‚úó No';
                document.getElementById('statConverged').className = 'value ' + (data.converged ? 'yes' : 'no');
                document.getElementById('statIter').textContent = data.n_iterations;
                document.getElementById('statLL').textContent = data.final_log_likelihood.toFixed(4);

                // Plots (base64 PNGs).
                if (data.plots.log_likelihood) {
                    document.getElementById('plotLL').src = 'data:image/png;base64,' + data.plots.log_likelihood;
                }
                if (data.plots.heatmap_A) {
                    document.getElementById('plotA').src = 'data:image/png;base64,' + data.plots.heatmap_A;
                }
                if (data.plots.heatmap_B) {
                    document.getElementById('plotB').src = 'data:image/png;base64,' + data.plots.heatmap_B;
                }

                // State diagram (SVG).
                if (data.plots.state_diagram) {
                    const svgRaw = atob(data.plots.state_diagram);
                    document.getElementById('stateDiagram').innerHTML = svgRaw;
                } else {
                    document.getElementById('stateDiagram').innerHTML = '<p style="color:var(--clr-muted);">Graphviz not available ‚Äî install the system binary to render state diagrams.</p>';
                }

                // Tables.
                renderMatrix('tableA', data.A, 'S', 'S');
                renderMatrix('tableB', data.B, 'S', 'O');
                renderVector('tablePi', data.pi);

                placeholder.style.display = 'none';
                results.classList.add('visible');

            } catch (err) {
                errorMsg.textContent = '‚ö† ' + err.message;
                errorMsg.classList.add('visible');
            } finally {
                btn.disabled = false;
                spinner.style.display = 'none';
                btnText.textContent = 'Train Model';
            }
        });

        // ‚îÄ‚îÄ‚îÄ Table Renderers ‚îÄ‚îÄ‚îÄ //
        function renderMatrix(tableId, matrix, rowPrefix, colPrefix) {
            const table = document.getElementById(tableId);
            let html = '<thead><tr><th></th>';
            for (let j = 0; j < matrix[0].length; j++) html += `<th>${colPrefix}${j}</th>`;
            html += '</tr></thead><tbody>';
            for (let i = 0; i < matrix.length; i++) {
                html += `<tr><th>${rowPrefix}${i}</th>`;
                for (let j = 0; j < matrix[i].length; j++) {
                    html += `<td>${matrix[i][j].toFixed(4)}</td>`;
                }
                html += '</tr>';
            }
            html += '</tbody>';
            table.innerHTML = html;
        }

        function renderVector(tableId, vec) {
            const table = document.getElementById(tableId);
            let html = '<thead><tr>';
            for (let i = 0; i < vec.length; i++) html += `<th>S${i}</th>`;
            html += '</tr></thead><tbody><tr>';
            for (let i = 0; i < vec.length; i++) html += `<td>${vec[i].toFixed(4)}</td>`;
            html += '</tr></tbody>';
            table.innerHTML = html;
        }
    </script>
</body>
</html>
