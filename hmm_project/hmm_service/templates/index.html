<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HMM — Live Baum–Welch Training Dashboard</title>
    <meta name="description"
        content="Real-time Hidden Markov Model training dashboard using the Baum-Welch Expectation-Maximization algorithm">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap"
        rel="stylesheet">

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        sapphire: {
                            50: '#eff4ff', 100: '#dbe6fe', 200: '#bfd3fe',
                            300: '#93b4fd', 400: '#6090fa', 500: '#2563eb',
                            600: '#1d4ed8', 700: '#1e40af', 800: '#1e3a8a', 900: '#1a2f6b',
                        },
                        academic: { bg: '#FAF9F6', card: '#FFFFFF', border: '#E2E0DC', muted: '#94918B' }
                    }
                }
            }
        }
    </script>

    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <!-- HMM Diagram -->
    <link rel="stylesheet" href="/static/css/hmm_diagram.css">

    <style>
        body {
            background-color: #FAF9F6;
            font-family: 'Inter', system-ui, sans-serif;
        }

        .font-mono-num {
            font-family: 'JetBrains Mono', monospace;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            80%,
            100% {
                transform: scale(2.2);
                opacity: 0;
            }
        }

        .status-pulse .pulse-dot {
            animation: pulse-ring 1.4s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .card {
            background: #FFFFFF;
            border: 1px solid #E2E0DC;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.03);
        }

        .heatmap-cell {
            transition: background-color 0.3s ease;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
        }

        /* ── (HMM Diagram styles in /static/css/hmm_diagram.css) ── */

        .pi-bar {
            transition: width 0.3s ease;
            background: linear-gradient(90deg, #2563EB, #6090fa);
            border-radius: 3px;
            height: 28px;
        }

        .section-title {
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #94918B;
        }

        .js-plotly-plot .plotly .modebar {
            display: none !important;
        }

        .d3-tooltip {
            position: absolute;
            background: rgba(30, 58, 138, 0.92);
            color: #fff;
            padding: 6px 10px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            pointer-events: none;
            z-index: 50;
            white-space: nowrap;
        }

        /* ── Iteration Log Table ── */
        .iter-table {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.72rem;
        }

        .iter-table th {
            background: #f8f7f4;
            position: sticky;
            top: 0;
            z-index: 5;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 0.68rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
        }

        .iter-table td,
        .iter-table th {
            padding: 6px 10px;
            border-bottom: 1px solid #f1f0ed;
            white-space: nowrap;
        }

        .iter-table tbody tr:hover {
            background: #f8f7f4;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #d1d0cc;
            border-radius: 3px;
        }
    </style>
</head>

<body class="min-h-screen antialiased text-slate-800">

    <!-- ══════════════ 1. HEADER ══════════════ -->
    <header class="border-b border-academic-border bg-white/60 backdrop-blur-sm sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-6 py-5 flex items-center justify-between">
            <div>
                <h1 class="text-xl font-semibold text-slate-900 tracking-tight">
                    Hidden Markov Model &mdash; Live Baum&ndash;Welch Training
                </h1>
                <p class="text-sm text-academic-muted mt-0.5">
                    Expectation&ndash;Maximization Optimization Dashboard
                </p>
            </div>
            <div id="status-badge"
                class="flex items-center gap-2 px-3 py-1.5 rounded-full border border-academic-border text-xs font-medium text-academic-muted bg-academic-bg">
                <span class="w-2 h-2 rounded-full bg-slate-400"></span>
                <span id="status-text">Idle</span>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-8 space-y-10">

        <!-- ══════════════ 2. CONFIGURATION ══════════════ -->
        <section>
            <p class="section-title mb-3">Configuration</p>
            <div class="card p-6">
                <form id="train-form" class="space-y-5">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                        <div>
                            <label for="n-states" class="block text-sm font-medium text-slate-700 mb-1.5">Hidden States
                                (N)</label>
                            <input id="n-states" type="number" min="2" max="10" value="2"
                                class="w-full px-3 py-2 border border-academic-border rounded-md text-sm font-mono-num focus:outline-none focus:ring-2 focus:ring-sapphire-300 focus:border-sapphire-400 bg-white">
                        </div>
                        <div>
                            <label for="max-iter" class="block text-sm font-medium text-slate-700 mb-1.5">Max
                                Iterations</label>
                            <input id="max-iter" type="number" min="1" max="2000" value="100"
                                class="w-full px-3 py-2 border border-academic-border rounded-md text-sm font-mono-num focus:outline-none focus:ring-2 focus:ring-sapphire-300 focus:border-sapphire-400 bg-white">
                        </div>
                        <div>
                            <label for="tolerance"
                                class="block text-sm font-medium text-slate-700 mb-1.5">Tolerance</label>
                            <input id="tolerance" type="text" value="1e-6"
                                class="w-full px-3 py-2 border border-academic-border rounded-md text-sm font-mono-num focus:outline-none focus:ring-2 focus:ring-sapphire-300 focus:border-sapphire-400 bg-white">
                        </div>
                    </div>
                    <div>
                        <label for="observations" class="block text-sm font-medium text-slate-700 mb-1.5">Observation
                            Sequence (comma-separated integers, 0-based)</label>
                        <textarea id="observations" rows="3"
                            class="w-full px-3 py-2 border border-academic-border rounded-md text-sm font-mono-num leading-relaxed focus:outline-none focus:ring-2 focus:ring-sapphire-300 focus:border-sapphire-400 bg-white resize-y"
                            placeholder="e.g. 0, 1, 2, 0, 0, 1, 2, 1, 0, 2">0, 1, 2, 0, 0, 1, 2, 1, 0, 2, 2, 0, 1, 0, 1, 2, 2, 0, 1, 1, 0, 2, 0, 1, 2, 0, 0, 1, 2, 1, 0, 2, 2, 0, 1, 0, 1, 2, 2, 0, 1, 1, 0, 2, 0, 1, 2, 0, 0, 1</textarea>
                    </div>
                    <div class="flex items-center gap-3 pt-1">
                        <button type="button" id="preset-weather"
                            class="text-xs px-3 py-1.5 rounded border border-academic-border text-slate-600 hover:bg-slate-50 transition">Load
                            Weather Preset</button>
                        <button type="button" id="preset-dna"
                            class="text-xs px-3 py-1.5 rounded border border-academic-border text-slate-600 hover:bg-slate-50 transition">Load
                            DNA Preset</button>
                    </div>

                    <!-- Advanced Settings -->
                    <div class="pt-3 pb-1 border-gray-100">
                        <details class="group">
                            <summary
                                class="flex items-center gap-2 cursor-pointer list-none text-xs font-semibold text-slate-500 hover:text-slate-700 transition select-none">
                                <svg class="w-3 h-3 transition group-open:rotate-90 text-slate-400" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path d="M9 5l7 7-7 7"></path>
                                </svg>
                                <span>Advanced Initialization</span>
                            </summary>
                            <div
                                class="mt-2 space-y-3 p-3 bg-slate-50 rounded border border-slate-100 text-xs text-academic-muted">
                                <div>
                                    <label class="block font-medium mb-1 text-slate-700">Transition Matrix A
                                        (JSON)</label>
                                    <textarea id="init-a" rows="3"
                                        class="w-full font-mono border-gray-300 rounded focus:ring-sapphire-500 focus:border-sapphire-500 text-xs"
                                        placeholder="[[0.7, 0.3], [0.4, 0.6]]" spellcheck="false"></textarea>
                                </div>
                                <div>
                                    <label class="block font-medium mb-1 text-slate-700">Emission Matrix B
                                        (JSON)</label>
                                    <textarea id="init-b" rows="3"
                                        class="w-full font-mono border-gray-300 rounded focus:ring-sapphire-500 focus:border-sapphire-500 text-xs"
                                        placeholder="[[0.9, 0.1], [0.2, 0.8]]" spellcheck="false"></textarea>
                                </div>
                                <div>
                                    <label class="block font-medium mb-1 text-slate-700">Initial Probabilities &pi;
                                        (JSON)</label>
                                    <input type="text" id="init-pi"
                                        class="w-full font-mono border-gray-300 rounded focus:ring-sapphire-500 focus:border-sapphire-500 text-xs h-8"
                                        placeholder="[0.6, 0.4]" spellcheck="false">
                                </div>
                                <p class="text-amber-600 italic text-[10px]">* Leave empty for random initialization.
                                    Metrics validation is performed on server.</p>
                            </div>
                        </details>
                    </div>

                    <div class="pt-2">
                        <button type="submit" id="train-btn"
                            class="inline-flex items-center px-5 py-2.5 bg-sapphire-500 text-white text-sm font-medium rounded-md hover:bg-sapphire-600 focus:outline-none focus:ring-2 focus:ring-sapphire-300 disabled:opacity-50 disabled:cursor-not-allowed transition">
                            <svg id="train-spinner" class="hidden animate-spin -ml-1 mr-2 h-4 w-4 text-white"
                                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                            </svg>
                            <span id="train-btn-text">Train Model</span>
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <!-- ══════════════ 3. LIVE METRICS ══════════════ -->
        <section id="results-section" class="hidden">
            <p class="section-title mb-3">Live Metrics</p>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="card p-4">
                    <p class="text-xs text-academic-muted font-medium mb-1">Iteration</p>
                    <p id="metric-iter" class="text-2xl font-mono-num font-semibold text-slate-800">&mdash;</p>
                </div>
                <div class="card p-4">
                    <p class="text-xs text-academic-muted font-medium mb-1">Log-Likelihood</p>
                    <p id="metric-ll" class="text-2xl font-mono-num font-semibold text-slate-800">&mdash;</p>
                </div>
                <div class="card p-4">
                    <p class="text-xs text-academic-muted font-medium mb-1">&Delta; (Change)</p>
                    <p id="metric-delta" class="text-2xl font-mono-num font-semibold text-slate-800">&mdash;</p>
                </div>
                <div class="card p-4">
                    <p class="text-xs text-academic-muted font-medium mb-1">Status</p>
                    <p id="metric-status" class="text-2xl font-semibold text-slate-800">&mdash;</p>
                </div>
            </div>
        </section>

        <!-- ══════════════ 4. LOG-LIKELIHOOD CHART ══════════════ -->
        <section id="ll-section" class="hidden">
            <p class="section-title mb-3">Log-Likelihood Convergence &mdash; log P(O|&lambda;)</p>
            <div class="card p-5">
                <div id="ll-chart" style="width:100%; height:320px;"></div>
            </div>
        </section>

        <!-- ══════════════ 4b. P(O|lambda) CHART ══════════════ -->
        <section id="prob-section" class="hidden">
            <p class="section-title mb-3">Observation Probability &mdash; P(O|&lambda;)</p>
            <div class="card p-5">
                <div id="prob-chart" style="width:100%; height:320px;"></div>
            </div>
        </section>

        <!-- ══════════════ 4c. ERROR CHART (1 - P(O|lambda)) ══════════════ -->
        <section id="error-section" class="hidden">
            <p class="section-title mb-3">Optimization Loss (-LogLikelihood)</p>
            <div class="card p-5">
                <div id="error-chart" style="width:100%; height:320px;"></div>
            </div>
        </section>

        <!-- ══════════════ 5. STATE DIAGRAM ══════════════ -->
        <section id="diagram-section" class="hidden">
            <p class="section-title mb-3">HMM State Transition Diagram</p>
            <div class="card p-6">
                <!-- Diagram Canvas -->
                <div id="state-diagram-container" class="hmm-canvas" style="height:720px;"></div>

                <!-- Replay Controls -->
                <div class="hmm-controls mt-4">
                    <button id="hmm-first" class="hmm-ctrl-btn" title="First" disabled>⏮</button>
                    <button id="hmm-back" class="hmm-ctrl-btn" title="Step Back" disabled>⏪</button>
                    <button id="hmm-play" class="hmm-ctrl-btn" title="Play / Pause" disabled>▶</button>
                    <button id="hmm-fwd" class="hmm-ctrl-btn" title="Step Forward" disabled>⏩</button>
                    <button id="hmm-last" class="hmm-ctrl-btn" title="Last" disabled>⏭</button>
                    <select id="hmm-speed" class="hmm-speed-select" title="Playback Speed">
                        <option value="0.25">0.25×</option>
                        <option value="0.5">0.5×</option>
                        <option value="1" selected>1×</option>
                        <option value="2">2×</option>
                        <option value="5">5×</option>
                    </select>
                    <input id="hmm-timeline" class="hmm-timeline" type="range" min="0" max="0" value="0"
                        title="Iteration Timeline">
                    <span id="hmm-iter-label" class="hmm-iter-label">No data</span>
                    <button id="hmm-particles" class="hmm-ctrl-btn active" title="Toggle Particles">✦</button>
                </div>

                <!-- Inspector Panel -->
                <div id="hmm-inspector" class="hmm-inspector mt-4"></div>
            </div>
        </section>

        <!-- ══════════════ 6-7. HEATMAPS ══════════════ -->
        <section id="heatmaps-section" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <p class="section-title mb-3">Transition Matrix A</p>
                    <div class="card p-5">
                        <div id="heatmap-A" class="flex justify-center"></div>
                    </div>
                </div>
                <div>
                    <p class="section-title mb-3">Emission Matrix B</p>
                    <div class="card p-5">
                        <div id="heatmap-B" class="flex justify-center"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ══════════════ 8. PI BARS ══════════════ -->
        <section id="pi-section" class="hidden">
            <p class="section-title mb-3">Initial Distribution &pi;</p>
            <div class="card p-5">
                <div id="pi-bars" class="space-y-3"></div>
            </div>
        </section>

        <!-- ══════════════ 9. PARAMETER EVOLUTION ══════════════ -->
        <section id="evolution-section" class="hidden">
            <p class="section-title mb-3">Parameter Evolution &mdash; A[i][j] over iterations</p>
            <div class="card p-5">
                <div id="evolution-chart" style="width:100%; height:320px;"></div>
            </div>
        </section>

        <!-- ══════════════ 10. ITERATION LOG TABLE ══════════════ -->
        <section id="iterlog-section" class="hidden">
            <p class="section-title mb-3">Iteration Log</p>
            <div class="card">
                <div style="max-height: 420px; overflow-y: auto; overflow-x: auto;">
                    <table class="iter-table w-full text-left" id="iter-table">
                        <thead>
                            <tr id="iter-table-head"></tr>
                        </thead>
                        <tbody id="iter-table-body"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- ══════════════ 11. FINAL SUMMARY TABLE ══════════════ -->
        <section id="summary-section" class="hidden">
            <p class="section-title mb-3">Final Learned Parameters</p>
            <div class="card p-6" id="summary-content"></div>
        </section>

        <!-- ══════════════ 12. ALGORITHM EXPLANATION ══════════════ -->
        <section>
            <p class="section-title mb-3">Algorithm Reference</p>
            <div class="card p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-sm text-slate-700 leading-relaxed">
                    <div>
                        <h3 class="font-semibold text-slate-900 mb-2">Hidden Markov Model</h3>
                        <p class="mb-3">An HMM is defined by <span class="font-mono-num text-sapphire-700">&lambda; =
                                (A, B, &pi;)</span> where
                            <strong>A</strong> is the state transition matrix,
                            <strong>B</strong> is the observation emission matrix, and
                            <strong>&pi;</strong> is the initial state distribution.
                        </p>
                        <h3 class="font-semibold text-slate-900 mb-2">Baum&ndash;Welch Algorithm</h3>
                        <p>An EM procedure that iteratively re-estimates the HMM parameters to maximize
                            <span class="font-mono-num text-sapphire-700">P(O|&lambda;)</span>.
                            Each iteration is guaranteed to increase (or maintain) the log-likelihood.
                        </p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-slate-900 mb-2">E-Step</h3>
                        <ul class="list-disc list-inside space-y-1 mb-3 text-slate-600">
                            <li>Compute <span class="font-mono-num">&alpha;</span> (forward variables)</li>
                            <li>Compute <span class="font-mono-num">&beta;</span> (backward variables)</li>
                            <li>Compute <span class="font-mono-num">&gamma;<sub>t</sub>(i)</span> =
                                P(q<sub>t</sub>=S<sub>i</sub> | O, &lambda;)</li>
                            <li>Compute <span class="font-mono-num">&xi;<sub>t</sub>(i,j)</span> =
                                P(q<sub>t</sub>=S<sub>i</sub>, q<sub>t+1</sub>=S<sub>j</sub> | O, &lambda;)</li>
                        </ul>
                        <h3 class="font-semibold text-slate-900 mb-2">M-Step</h3>
                        <ul class="list-disc list-inside space-y-1 text-slate-600">
                            <li>Update <span class="font-mono-num">A[i][j]</span> = &Sigma;&xi; / &Sigma;&gamma;</li>
                            <li>Update <span class="font-mono-num">B[j][k]</span> = &Sigma;&gamma;(O<sub>t</sub>=k) /
                                &Sigma;&gamma;</li>
                            <li>Update <span class="font-mono-num">&pi;[i]</span> = &gamma;<sub>1</sub>(i)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- ══════════════ FOOTER ══════════════ -->
    <footer class="border-t border-academic-border mt-12">
        <div class="max-w-7xl mx-auto px-6 py-5 flex items-center justify-between text-xs text-academic-muted">
            <span>HMM Baum&ndash;Welch Engine &middot; v1.0</span>
            <span>Flask-SocketIO &middot; D3.js &middot; Plotly.js</span>
        </div>
    </footer>

    <div id="d3-tooltip" class="d3-tooltip" style="display:none;"></div>

    <!-- ══════════════════════════════════════════════════════════════════
     JAVASCRIPT
     ══════════════════════════════════════════════════════════════════ -->
    <script src="/static/js/hmm_diagram.js?v=6"></script>
    <script>
            (function () {
                'use strict';

                // ── State ──
                let socket = null;
                let llData = { x: [], y: [] };
                let probData = { x: [], y: [] };
                let errorData = { x: [], y: [] };
                let prevLL = null;
                let nStates = 2;
                let nObsSymbols = 3;
                let evolutionData = {};
                let hmmDiagram = null;
                let lastData = null;
                let iterCount = 0;

                // ── DOM ──
                const form = document.getElementById('train-form');
                const trainBtn = document.getElementById('train-btn');
                const trainBtnText = document.getElementById('train-btn-text');
                const trainSpinner = document.getElementById('train-spinner');
                const statusBadge = document.getElementById('status-badge');
                const statusText = document.getElementById('status-text');
                const tooltip = document.getElementById('d3-tooltip');

                const SECTIONS = ['results-section', 'll-section', 'prob-section', 'error-section', 'diagram-section',
                    'heatmaps-section', 'pi-section', 'evolution-section', 'iterlog-section'];

                // ── Presets ──
                document.getElementById('preset-weather').addEventListener('click', () => {
                    document.getElementById('n-states').value = 2;
                    document.getElementById('observations').value =
                        '0, 1, 2, 0, 0, 1, 2, 1, 0, 2, 2, 0, 1, 0, 1, 2, 2, 0, 1, 1, ' +
                        '0, 2, 0, 1, 2, 0, 0, 1, 2, 1, 0, 2, 2, 0, 1, 0, 1, 2, 2, 0, ' +
                        '1, 1, 0, 2, 0, 1, 2, 0, 0, 1, 2, 1, 0, 2, 2, 0, 1, 0, 1, 2';
                    document.getElementById('max-iter').value = 100;
                    document.getElementById('tolerance').value = '1e-6';
                });
                document.getElementById('preset-dna').addEventListener('click', () => {
                    document.getElementById('n-states').value = 3;
                    document.getElementById('observations').value =
                        '0, 1, 2, 3, 0, 1, 0, 2, 3, 1, 2, 0, 3, 1, 2, 0, 0, 1, 3, 2, ' +
                        '1, 0, 3, 2, 1, 0, 2, 3, 0, 1, 2, 3, 0, 1, 0, 2, 3, 1, 2, 0, ' +
                        '3, 1, 2, 0, 0, 1, 3, 2, 1, 0, 3, 2, 1, 0, 2, 3, 0, 1, 2, 3';
                    document.getElementById('max-iter').value = 150;
                    document.getElementById('tolerance').value = '1e-8';
                });

                // ── Status helpers ──
                function setStatus(status) {
                    const dot = statusBadge.querySelector('span:first-child');
                    statusText.textContent = status;
                    dot.innerHTML = '';
                    dot.style.position = '';
                    if (status === 'Training') {
                        dot.className = 'w-2 h-2 rounded-full bg-sapphire-500 status-pulse';
                        dot.innerHTML = '<span class="absolute w-2 h-2 rounded-full bg-sapphire-400 pulse-dot"></span>';
                        dot.style.position = 'relative';
                        statusBadge.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full border border-sapphire-200 text-xs font-medium text-sapphire-600 bg-sapphire-50';
                    } else if (status === 'Converged') {
                        dot.className = 'w-2 h-2 rounded-full bg-emerald-500';
                        statusBadge.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full border border-emerald-300 text-xs font-medium text-emerald-700 bg-emerald-50';
                    } else {
                        dot.className = 'w-2 h-2 rounded-full bg-slate-400';
                        statusBadge.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full border border-academic-border text-xs font-medium text-academic-muted bg-academic-bg';
                    }
                }

                function setTraining(active) {
                    trainBtn.disabled = active;
                    trainSpinner.classList.toggle('hidden', !active);
                    trainBtnText.textContent = active ? 'Training...' : 'Train Model';
                }

                // ══════════════════════════════════════════════════
                //  FORM SUBMIT → WebSocket
                // ══════════════════════════════════════════════════
                form.addEventListener('submit', function (e) {
                    e.preventDefault();

                    nStates = parseInt(document.getElementById('n-states').value, 10);
                    const obsText = document.getElementById('observations').value;
                    const maxIter = parseInt(document.getElementById('max-iter').value, 10);
                    const tol = parseFloat(document.getElementById('tolerance').value);

                    const observations = obsText.split(',').map(s => parseInt(s.trim(), 10)).filter(n => !isNaN(n));
                    if (observations.length < 2) { alert('Need at least 2 observations.'); return; }
                    nObsSymbols = Math.max(...observations) + 1;

                    // Reset
                    llData = { x: [], y: [] };
                    probData = { x: [], y: [] };
                    errorData = { x: [], y: [] };
                    prevLL = null;
                    evolutionData = {};
                    if (hmmDiagram) hmmDiagram.reset();
                    hmmDiagram = new HMMDiagram('#state-diagram-container', '#hmm-inspector');
                    hmmDiagram.wireControls({
                        btnFirst: document.getElementById('hmm-first'),
                        btnBack: document.getElementById('hmm-back'),
                        btnPlay: document.getElementById('hmm-play'),
                        btnForward: document.getElementById('hmm-fwd'),
                        btnLast: document.getElementById('hmm-last'),
                        speedSelect: document.getElementById('hmm-speed'),
                        timeline: document.getElementById('hmm-timeline'),
                        iterLabel: document.getElementById('hmm-iter-label'),
                        btnParticles: document.getElementById('hmm-particles'),
                    });
                    lastData = null;
                    iterCount = 0;

                    for (let i = 0; i < nStates; i++)
                        for (let j = 0; j < nStates; j++)
                            evolutionData[`A[${i}][${j}]`] = { x: [], y: [] };

                    // Show sections
                    SECTIONS.forEach(id => document.getElementById(id).classList.remove('hidden'));
                    document.getElementById('summary-section').classList.add('hidden');
                    document.getElementById('metric-iter').textContent = '\u2014';
                    document.getElementById('metric-ll').textContent = '\u2014';
                    document.getElementById('metric-delta').textContent = '\u2014';
                    document.getElementById('metric-status').textContent = 'Starting';
                    document.getElementById('metric-status').className = 'text-2xl font-semibold text-sapphire-600';

                    // Build iteration log table header
                    buildIterTableHeader();
                    document.getElementById('iter-table-body').innerHTML = '';

                    setStatus('Training');
                    setTraining(true);
                    initLLChart();
                    initProbChart();
                    initErrorChart();
                    initEvolutionChart();

                    // Connect
                    if (socket) socket.disconnect();
                    socket = io();

                    socket.on('connect', () => {
                        // Gather initialization params
                        const rawA = document.getElementById('init-a').value.trim();
                        const rawB = document.getElementById('init-b').value.trim();
                        const rawPi = document.getElementById('init-pi').value.trim();
                        let initParams = null;

                        try {
                            if (rawA || rawB || rawPi) {
                                initParams = {};
                                if (rawA) initParams.A = JSON.parse(rawA);
                                if (rawB) initParams.B = JSON.parse(rawB);
                                if (rawPi) initParams.pi = JSON.parse(rawPi);
                            }
                        } catch (err) {
                            alert("Invalid JSON in Advanced Settings: " + err.message);
                            setTraining(false);
                            return;
                        }

                        socket.emit('start_training', {
                            n_states: nStates,
                            observations: observations,
                            max_iterations: maxIter,
                            tolerance: tol,
                            init_params: initParams
                        });
                    });

                    socket.on('training_update', function (data) {
                        iterCount++;
                        lastData = data;
                        updateMetrics(data);
                        updateLLChart(data);
                        updateProbChart(data);
                        updateErrorChart(data);
                        if (hmmDiagram) hmmDiagram.feedIteration(data);
                        updateHeatmaps(data.A, data.B);
                        updatePi(data.pi);
                        updateEvolution(data);
                        appendIterRow(data);
                    });

                    socket.on('training_complete', function (data) {
                        setTraining(false);
                        if (data.converged) {
                            setStatus('Converged');
                            document.getElementById('metric-status').textContent = 'Converged';
                            document.getElementById('metric-status').className = 'text-2xl font-semibold text-emerald-600';
                        } else {
                            setStatus('Max Iterations');
                            document.getElementById('metric-status').textContent = 'Max Iter';
                            document.getElementById('metric-status').className = 'text-2xl font-semibold text-amber-600';
                        }
                        // Build final summary
                        if (lastData) buildFinalSummary(lastData, data);
                    });

                    socket.on('training_error', function (data) {
                        setTraining(false);
                        setStatus('Error');
                        alert('Training error: ' + data.error);
                    });
                });

                // ══════════════════════════════════════════════════
                //  3. METRICS
                // ══════════════════════════════════════════════════
                function updateMetrics(data) {
                    document.getElementById('metric-iter').textContent = data.iteration;
                    document.getElementById('metric-ll').textContent = data.log_likelihood.toFixed(4);
                    const delta = prevLL !== null ? (data.log_likelihood - prevLL) : 0;
                    document.getElementById('metric-delta').textContent = (delta >= 0 ? '+' : '') + delta.toExponential(3);
                    document.getElementById('metric-status').textContent = data.converged ? 'Converged' : 'Running';
                    if (data.converged) {
                        document.getElementById('metric-status').className = 'text-2xl font-semibold text-emerald-600';
                    }
                    prevLL = data.log_likelihood;
                }

                // ══════════════════════════════════════════════════
                //  4. LOG-LIKELIHOOD CHART
                // ══════════════════════════════════════════════════
                function initLLChart() {
                    Plotly.newPlot('ll-chart', [{
                        x: [], y: [], mode: 'lines',
                        line: { color: '#2563EB', width: 2 },
                        hovertemplate: 'Iteration %{x}<br>log P(O|\u03bb): %{y:.6f}<extra></extra>'
                    }], {
                        margin: { t: 10, r: 30, b: 45, l: 75 },
                        xaxis: { title: { text: 'Iteration', font: { family: 'Inter', size: 12, color: '#64748b' } }, gridcolor: '#f1f0ed', zeroline: false },
                        yaxis: { title: { text: 'log P(O|\u03bb)', font: { family: 'Inter', size: 12, color: '#64748b' } }, gridcolor: '#f1f0ed', zeroline: false },
                        paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                        font: { family: 'JetBrains Mono', size: 10, color: '#64748b' },
                        hovermode: 'x unified'
                    }, { responsive: true, displayModeBar: false });
                }

                function updateLLChart(data) {
                    Plotly.extendTraces('ll-chart', { x: [[data.iteration]], y: [[data.log_likelihood]] }, [0]);
                }

                // ══════════════════════════════════════════════════
                //  4b. P(O|lambda) CHART
                // ══════════════════════════════════════════════════
                function initProbChart() {
                    Plotly.newPlot('prob-chart', [{
                        x: [], y: [], mode: 'lines',
                        line: { color: '#059669', width: 2 },
                        hovertemplate: 'Iteration %{x}<br>P(O|\u03bb): %{y:.6e}<extra></extra>'
                    }], {
                        margin: { t: 10, r: 30, b: 45, l: 75 },
                        xaxis: { title: { text: 'Iteration', font: { family: 'Inter', size: 12, color: '#64748b' } }, gridcolor: '#f1f0ed', zeroline: false },
                        yaxis: { title: { text: 'P(O|\u03bb)', font: { family: 'Inter', size: 12, color: '#64748b' } }, gridcolor: '#f1f0ed', zeroline: false, exponentformat: 'e' },
                        paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                        font: { family: 'JetBrains Mono', size: 10, color: '#64748b' },
                        hovermode: 'x unified'
                    }, { responsive: true, displayModeBar: false });
                }

                function updateProbChart(data) {
                    const prob = Math.exp(data.log_likelihood);
                    Plotly.extendTraces('prob-chart', { x: [[data.iteration]], y: [[prob]] }, [0]);
                }

                // ══════════════════════════════════════════════════
                //  4c. ERROR CHART
                // ══════════════════════════════════════════════════
                function initErrorChart() {
                    Plotly.newPlot('error-chart', [{
                        x: [], y: [], mode: 'lines',
                        line: { color: '#EF4444', width: 2 },
                        hovertemplate: 'Iteration %{x}<br>Loss: %{y:.4f}<extra></extra>'
                    }], {
                        margin: { t: 10, r: 30, b: 45, l: 75 },
                        xaxis: { title: { text: 'Iteration', font: { family: 'Inter', size: 12, color: '#64748b' } }, gridcolor: '#f1f0ed', zeroline: false },
                        yaxis: { title: { text: 'NLL (-log P)', font: { family: 'Inter', size: 12, color: '#64748b' } }, gridcolor: '#f1f0ed', zeroline: false },
                        paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                        font: { family: 'JetBrains Mono', size: 10, color: '#64748b' },
                        hovermode: 'x unified'
                    }, { responsive: true, displayModeBar: false });
                }

                function updateErrorChart(data) {
                    // Use Negative Log Likelihood as "Error" (Loss)
                    const loss = -data.log_likelihood;
                    Plotly.extendTraces('error-chart', { x: [[data.iteration]], y: [[loss]] }, [0]);
                }

                // (State diagram handled by external HMMDiagram class)

                // ══════════════════════════════════════════════════
                //  6-7. HEATMAPS
                // ══════════════════════════════════════════════════
                function updateHeatmaps(A, B) {
                    renderHeatmap('heatmap-A', A, 'S', 'S');
                    renderHeatmap('heatmap-B', B, 'S', 'O');
                }

                function renderHeatmap(id, matrix, rPfx, cPfx) {
                    const el = document.getElementById(id);
                    const R = matrix.length, C = matrix[0].length;
                    const cs = 60;
                    let h = '<table class="border-collapse"><tr><td class="w-10"></td>';
                    for (let j = 0; j < C; j++)
                        h += `<td class="text-center text-xs font-medium text-academic-muted pb-2" style="width:${cs}px">${cPfx}${j}</td>`;
                    h += '</tr>';
                    for (let i = 0; i < R; i++) {
                        h += `<tr><td class="text-right text-xs font-medium text-academic-muted pr-3">${rPfx}${i}</td>`;
                        for (let j = 0; j < C; j++) {
                            const v = matrix[i][j];
                            const r = Math.round(255 - v * (255 - 37));
                            const g = Math.round(255 - v * (255 - 99));
                            const b = Math.round(255 - v * (255 - 235));
                            const tc = v > 0.55 ? '#fff' : '#1e293b';
                            h += `<td class="heatmap-cell text-center border border-slate-100"
                          style="width:${cs}px;height:${cs}px;background:rgb(${r},${g},${b});color:${tc};line-height:${cs}px;">
                          ${v.toFixed(3)}</td>`;
                        }
                        h += '</tr>';
                    }
                    h += '</table>';
                    el.innerHTML = h;
                }

                // ══════════════════════════════════════════════════
                //  8. PI BARS
                // ══════════════════════════════════════════════════
                function updatePi(pi) {
                    const el = document.getElementById('pi-bars');
                    let h = '';
                    for (let i = 0; i < pi.length; i++) {
                        const pct = (pi[i] * 100).toFixed(1);
                        h += `<div class="flex items-center gap-3">
                    <span class="text-xs font-medium text-slate-600 w-8">S${i}</span>
                    <div class="flex-1 bg-slate-100 rounded h-7 overflow-hidden">
                        <div class="pi-bar" style="width:${pct}%; min-width:2px;"></div>
                    </div>
                    <span class="font-mono-num text-xs text-slate-700 w-16 text-right">${pi[i].toFixed(4)}</span>
                </div>`;
                    }
                    el.innerHTML = h;
                }

                // ══════════════════════════════════════════════════
                //  9. PARAMETER EVOLUTION
                // ══════════════════════════════════════════════════
                const evoColors = ['#2563EB', '#7C3AED', '#DC2626', '#059669', '#D97706', '#0891B2', '#BE185D', '#6D28D9', '#CA8A04', '#166534'];

                function initEvolutionChart() {
                    const traces = [];
                    let idx = 0;
                    for (let i = 0; i < nStates; i++) {
                        for (let j = 0; j < nStates; j++) {
                            traces.push({
                                x: [], y: [], mode: 'lines', name: `A[${i}][${j}]`,
                                line: { color: evoColors[idx % evoColors.length], width: 1.5 },
                                hovertemplate: `A[${i}][${j}] = %{y:.4f}<extra></extra>`
                            });
                            idx++;
                        }
                    }
                    Plotly.newPlot('evolution-chart', traces, {
                        margin: { t: 10, r: 30, b: 45, l: 60 },
                        xaxis: { title: { text: 'Iteration', font: { family: 'Inter', size: 12, color: '#64748b' } }, gridcolor: '#f1f0ed', zeroline: false },
                        yaxis: { title: { text: 'Probability', font: { family: 'Inter', size: 12, color: '#64748b' } }, gridcolor: '#f1f0ed', zeroline: false, range: [0, 1] },
                        paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                        font: { family: 'JetBrains Mono', size: 10, color: '#64748b' },
                        legend: { font: { family: 'JetBrains Mono', size: 10 }, orientation: 'h', y: -0.22 },
                        hovermode: 'x unified'
                    }, { responsive: true, displayModeBar: false });
                }

                function updateEvolution(data) {
                    const A = data.A;
                    const xU = [], yU = [], indices = [];
                    let idx = 0;
                    for (let i = 0; i < A.length; i++)
                        for (let j = 0; j < A[i].length; j++) {
                            xU.push([data.iteration]); yU.push([A[i][j]]); indices.push(idx++);
                        }
                    Plotly.extendTraces('evolution-chart', { x: xU, y: yU }, indices);
                }

                // ══════════════════════════════════════════════════
                //  10. ITERATION LOG TABLE
                // ══════════════════════════════════════════════════
                function buildIterTableHeader() {
                    let h = '<th>Iter</th><th>Log-Likelihood</th><th>\u0394LL</th>';
                    for (let i = 0; i < nStates; i++)
                        for (let j = 0; j < nStates; j++)
                            h += `<th>A[${i}][${j}]</th>`;
                    for (let i = 0; i < nStates; i++)
                        for (let k = 0; k < nObsSymbols; k++)
                            h += `<th>B[${i}][${k}]</th>`;
                    for (let i = 0; i < nStates; i++)
                        h += `<th>\u03c0[${i}]</th>`;
                    document.getElementById('iter-table-head').innerHTML = h;
                }

                let prevLLForTable = null;
                function appendIterRow(data) {
                    const tbody = document.getElementById('iter-table-body');
                    const delta = prevLLForTable !== null ? (data.log_likelihood - prevLLForTable) : 0;
                    prevLLForTable = data.log_likelihood;

                    let cells = `<td>${data.iteration}</td>`;
                    cells += `<td>${data.log_likelihood.toFixed(6)}</td>`;
                    cells += `<td>${(delta >= 0 ? '+' : '')}${delta.toExponential(3)}</td>`;
                    for (let i = 0; i < data.A.length; i++)
                        for (let j = 0; j < data.A[i].length; j++)
                            cells += `<td>${data.A[i][j].toFixed(4)}</td>`;
                    for (let i = 0; i < data.B.length; i++)
                        for (let k = 0; k < data.B[i].length; k++)
                            cells += `<td>${data.B[i][k].toFixed(4)}</td>`;
                    for (let i = 0; i < data.pi.length; i++)
                        cells += `<td>${data.pi[i].toFixed(4)}</td>`;

                    const tr = document.createElement('tr');
                    tr.innerHTML = cells;
                    tbody.appendChild(tr);

                    // Auto-scroll to bottom
                    const wrapper = tbody.closest('div');
                    if (wrapper) wrapper.scrollTop = wrapper.scrollHeight;
                }

                // ══════════════════════════════════════════════════
                //  11. FINAL SUMMARY TABLE
                // ══════════════════════════════════════════════════
                function buildFinalSummary(lastData, completionData) {
                    const sec = document.getElementById('summary-section');
                    sec.classList.remove('hidden');

                    const A = lastData.A, B = lastData.B, pi = lastData.pi;
                    let html = '';

                    // Stats bar
                    html += `<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-slate-50 rounded p-3">
                <p class="text-xs text-academic-muted mb-0.5">Total Iterations</p>
                <p class="font-mono-num font-semibold text-lg">${completionData.n_iterations}</p>
            </div>
            <div class="bg-slate-50 rounded p-3">
                <p class="text-xs text-academic-muted mb-0.5">Final log P(O|&lambda;)</p>
                <p class="font-mono-num font-semibold text-lg">${completionData.final_log_likelihood.toFixed(6)}</p>
            </div>
            <div class="bg-slate-50 rounded p-3">
                <p class="text-xs text-academic-muted mb-0.5">Final P(O|&lambda;)</p>
                <p class="font-mono-num font-semibold text-lg">${Math.exp(completionData.final_log_likelihood).toExponential(4)}</p>
            </div>
            <div class="bg-slate-50 rounded p-3">
                <p class="text-xs text-academic-muted mb-0.5">Converged</p>
                <p class="font-semibold text-lg ${completionData.converged ? 'text-emerald-600' : 'text-amber-600'}">${completionData.converged ? 'Yes' : 'No (max iter)'}</p>
            </div>
        </div>`;

                    // ── Transition Matrix A ──
                    html += '<h3 class="text-sm font-semibold text-slate-700 mb-2">Transition Matrix A</h3>';
                    html += '<div class="overflow-x-auto mb-5"><table class="iter-table border-collapse border border-slate-200">';
                    html += '<tr><th class="border border-slate-200 bg-slate-50"></th>';
                    for (let j = 0; j < A[0].length; j++) html += `<th class="border border-slate-200 bg-slate-50 text-center">S${j}</th>`;
                    html += '</tr>';
                    for (let i = 0; i < A.length; i++) {
                        html += `<tr><td class="border border-slate-200 bg-slate-50 font-semibold text-center">S${i}</td>`;
                        for (let j = 0; j < A[i].length; j++)
                            html += `<td class="border border-slate-200 text-center">${A[i][j].toFixed(6)}</td>`;
                        html += '</tr>';
                    }
                    html += '</table></div>';

                    // ── Emission Matrix B ──
                    html += '<h3 class="text-sm font-semibold text-slate-700 mb-2">Emission Matrix B</h3>';
                    html += '<div class="overflow-x-auto mb-5"><table class="iter-table border-collapse border border-slate-200">';
                    html += '<tr><th class="border border-slate-200 bg-slate-50"></th>';
                    for (let k = 0; k < B[0].length; k++) html += `<th class="border border-slate-200 bg-slate-50 text-center">O${k}</th>`;
                    html += '</tr>';
                    for (let i = 0; i < B.length; i++) {
                        html += `<tr><td class="border border-slate-200 bg-slate-50 font-semibold text-center">S${i}</td>`;
                        for (let k = 0; k < B[i].length; k++)
                            html += `<td class="border border-slate-200 text-center">${B[i][k].toFixed(6)}</td>`;
                        html += '</tr>';
                    }
                    html += '</table></div>';

                    // ── Initial Distribution ──
                    html += '<h3 class="text-sm font-semibold text-slate-700 mb-2">Initial Distribution &pi;</h3>';
                    html += '<div class="overflow-x-auto"><table class="iter-table border-collapse border border-slate-200"><tr>';
                    for (let i = 0; i < pi.length; i++) html += `<th class="border border-slate-200 bg-slate-50 text-center">&pi;(S${i})</th>`;
                    html += '</tr><tr>';
                    for (let i = 0; i < pi.length; i++) html += `<td class="border border-slate-200 text-center">${pi[i].toFixed(6)}</td>`;
                    html += '</tr></table></div>';

                    document.getElementById('summary-content').innerHTML = html;

                    // Scroll to summary
                    sec.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }

            })();
    </script>


</body>

</html>